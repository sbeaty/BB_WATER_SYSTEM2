{% extends "base.html" %}

{% block title %}Dashboard - Water Monitoring System{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="bg-white overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Water Usage Dashboard</h1>
                    <p class="mt-1 text-sm text-gray-500">Real-time monitoring of water consumption across all systems</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-500">Last Update</div>
                    <div id="last-update" class="text-lg font-semibold text-gray-900">--:--:--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current Shift Info -->
    {% if current_shift %}
    <div class="bg-gradient-to-r from-blue-500 to-blue-600 overflow-hidden shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="flex items-center justify-between text-white">
                <div>
                    <h2 class="text-lg font-medium">{{ current_shift.shift_name }}</h2>
                    <p class="text-blue-100">
                        {{ current_shift.start_time.strftime('%H:%M') }} - {{ current_shift.end_time.strftime('%H:%M') }}
                        {% if current_shift.start_time.date() != current_shift.end_time.date() %}
                        ({{ current_shift.start_time.strftime('%d/%m') }} - {{ current_shift.end_time.strftime('%d/%m') }})
                        {% endif %}
                    </p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-blue-100">24-Hour Period</div>
                    <div class="text-sm">{{ day_start.strftime('%d/%m %H:%M') }} - {{ day_end.strftime('%d/%m %H:%M') }}</div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Color Legend -->
    <div class="bg-white shadow rounded-lg mb-6">
        <div class="px-4 py-3 border-b border-gray-200">
            <h3 class="text-sm font-medium text-gray-900">Status Legend</h3>
        </div>
        <div class="px-4 py-3">
            <div class="flex flex-wrap items-center space-x-6 text-xs">
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-green-100 border border-green-200 rounded mr-2"></div>
                    <span class="text-green-800 font-medium">Normal - Below Threshold</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-yellow-100 border border-yellow-200 rounded mr-2"></div>
                    <span class="text-yellow-800 font-medium">Warning - Near Threshold (>80%)</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-red-100 border border-red-200 rounded mr-2"></div>
                    <span class="text-red-800 font-medium">Critical - Threshold Exceeded</span>
                </div>
                <div class="flex items-center">
                    <div class="w-3 h-3 bg-gray-100 border border-gray-200 rounded mr-2"></div>
                    <span class="text-gray-600 font-medium">No Data Available</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Live Data Table -->
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Live Water Usage Monitoring</h3>
                    <p class="mt-1 text-sm text-gray-500">Real-time usage vs thresholds with color-coded status indicators</p>
                </div>
                <div class="flex space-x-2">
                    <button onclick="refreshData()" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-sync-alt mr-1"></i>
                        Refresh
                    </button>
                    <button onclick="toggleAutoRefresh()" id="auto-refresh-btn" class="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        <i class="fas fa-clock mr-1"></i>
                        Auto: ON
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">System & Threshold</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Reading</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usage vs Limit</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress Bar</th>
                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Updated</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="live-data-table">
                    {% for line_name, line_items in lines_data %}
                    <!-- Line Group Header -->
                    <tr class="bg-gradient-to-r from-blue-100 to-blue-50 border-t-2 border-blue-300">
                        <td colspan="6" class="px-6 py-3">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-8 w-8">
                                    <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center">
                                        <i class="fas fa-industry text-white text-sm"></i>
                                    </div>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-lg font-semibold text-blue-800">{{ line_name }}</h3>
                                    <p class="text-sm text-blue-600">{{ line_items|length }} monitoring point{{ 's' if line_items|length != 1 else '' }}</p>
                                </div>
                            </div>
                        </td>
                    </tr>
                    
                    {% for item in line_items %}
                    {% set target_value = item.shift_total if item.threshold.target == 'shift_total' else item.day_total if item.threshold.target == 'day_total' else item.current_value %}
                    {% set usage_percent = ((target_value / item.threshold.limit_value) * 100) if target_value and item.threshold.limit_value else 0 %}
                    {% set row_class = 'bg-red-50 border-l-4 border-red-400' if item.threshold_exceeded else ('bg-yellow-50 border-l-4 border-yellow-400' if usage_percent > 80 else ('bg-white' if target_value else 'bg-gray-50')) %}
                    
                    <tr data-threshold-ref="{{ item.threshold.threshold_ref }}" class="{{ row_class }} hover:bg-gray-50 transition-colors duration-150">
                        <!-- System & Threshold Info -->
                        <td class="px-6 py-4">
                            <div class="flex items-start">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full {% if item.threshold_exceeded %}bg-red-100{% elif usage_percent > 80 %}bg-yellow-100{% elif target_value %}bg-green-100{% else %}bg-gray-100{% endif %} flex items-center justify-center">
                                        <i class="fas fa-tint {% if item.threshold_exceeded %}text-red-600{% elif usage_percent > 80 %}text-yellow-600{% elif target_value %}text-green-600{% else %}text-gray-400{% endif %}"></i>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-bold text-gray-900">{{ item.tag_info.description }}</div>
                                    <div class="text-xs text-gray-500 mt-1">{{ item.tag_name }}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                            {{ item.threshold.target.replace('_', ' ').title() }}
                                        </span>
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Limit: {{ item.threshold.comparison_operator }} {{ "%.1f"|format(item.threshold.limit_value) }} {{ item.unit }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        
                        <!-- Current Reading -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                {% if item.current_value %}
                                    <div class="font-medium text-gray-900">{{ "%.1f"|format(item.current_value) }} {{ item.unit }}</div>
                                    <div class="text-xs text-gray-500">Totalizer Value</div>
                                {% else %}
                                    <div class="text-gray-400">No Data</div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Usage vs Limit -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm">
                                {% if target_value is not none and item.current_value is not none %}
                                    <div class="font-bold {% if item.threshold_exceeded %}text-red-600{% elif usage_percent > 80 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                        {{ "%.1f"|format(target_value) }} {{ item.unit }}
                                    </div>
                                    <div class="text-xs text-gray-500">
                                        of {{ "%.1f"|format(item.threshold.limit_value) }} limit
                                    </div>
                                    <div class="text-xs {% if item.threshold_exceeded %}text-red-600{% elif usage_percent > 80 %}text-yellow-600{% else %}text-gray-500{% endif %}">
                                        ({{ "%.1f"|format(usage_percent) }}%)
                                    </div>
                                {% else %}
                                    <div class="text-gray-400">No Data</div>
                                    <div class="text-xs text-gray-500">Data unavailable</div>
                                {% endif %}
                            </div>
                        </td>
                        
                        <!-- Status Badge -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if item.threshold_exceeded %}
                                <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium bg-red-100 text-red-800 border border-red-200">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    EXCEEDED
                                </span>
                                <div class="text-xs text-red-600 mt-1 font-medium">
                                    {{ item.threshold.severity.upper() }}
                                </div>
                            {% elif usage_percent > 80 %}
                                <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                    WARNING
                                </span>
                                <div class="text-xs text-yellow-600 mt-1">
                                    Near limit
                                </div>
                            {% elif target_value is not none and item.current_value is not none %}
                                <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200">
                                    <i class="fas fa-check mr-1"></i>
                                    NORMAL
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-1.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 border border-gray-200">
                                    <i class="fas fa-question mr-1"></i>
                                    NO DATA
                                </span>
                            {% endif %}
                        </td>
                        
                        <!-- Progress Bar -->
                        <td class="px-6 py-4 whitespace-nowrap">
                            {% if target_value and item.threshold.limit_value %}
                                <div class="w-full bg-gray-200 rounded-full h-2.5">
                                    <div class="{% if item.threshold_exceeded %}bg-red-500{% elif usage_percent > 80 %}bg-yellow-500{% else %}bg-green-500{% endif %} h-2.5 rounded-full transition-all duration-300" 
                                         style="width: {{ min(usage_percent, 100) }}%"></div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 text-center">
                                    {{ "%.0f"|format(min(usage_percent, 100)) }}%
                                </div>
                            {% else %}
                                <div class="w-full bg-gray-100 rounded-full h-2.5">
                                    <div class="bg-gray-300 h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                                <div class="text-xs text-gray-400 mt-1 text-center">N/A</div>
                            {% endif %}
                        </td>
                        
                        <!-- Last Updated -->
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {% if item.last_updated %}
                                <div>{{ item.last_updated.strftime('%H:%M:%S') }}</div>
                                <div class="text-xs text-gray-400">{{ item.last_updated.strftime('%d/%m') }}</div>
                            {% else %}
                                <div class="text-gray-400">No timestamp</div>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if not lines_data %}
        <div class="text-center py-12">
            <i class="fas fa-database text-gray-400 text-4xl mb-4"></i>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No Data Available</h3>
            <p class="text-gray-500">Unable to retrieve live data from the historian database.</p>
            <button onclick="location.reload()" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                <i class="fas fa-sync-alt mr-2"></i>
                Retry Connection
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Recent Alarms -->
    {% if recent_alarms %}
    <div class="bg-white shadow overflow-hidden sm:rounded-lg">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Recent Alarms</h3>
                    <p class="mt-1 text-sm text-gray-500">Latest threshold violations and alerts</p>
                </div>
                <a href="{{ url_for('alarms') }}" class="text-sm text-blue-600 hover:text-blue-500">View All →</a>
            </div>
        </div>
        
        <div class="divide-y divide-gray-200">
            {% for alarm in recent_alarms[:10] %}
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            {% if alarm.severity == 'critical' %}
                                <div class="h-8 w-8 rounded-full bg-red-100 flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600"></i>
                                </div>
                            {% elif alarm.severity == 'warn' %}
                                <div class="h-8 w-8 rounded-full bg-yellow-100 flex items-center justify-center">
                                    <i class="fas fa-exclamation-circle text-yellow-600"></i>
                                </div>
                            {% else %}
                                <div class="h-8 w-8 rounded-full bg-blue-100 flex items-center justify-center">
                                    <i class="fas fa-info-circle text-blue-600"></i>
                                </div>
                            {% endif %}
                        </div>
                        <div class="ml-4">
                            <div class="text-sm font-medium text-gray-900">{{ alarm.threshold_ref }}</div>
                            <div class="text-sm text-gray-500">{{ alarm.message }}</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-900">{{ "%.1f"|format(alarm.value) }}</div>
                        <div class="text-xs text-gray-500">{{ alarm.triggered_at.strftime('%H:%M') }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-red-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Active Alarms</dt>
                            <dd class="text-lg font-medium text-gray-900">
                                {{ live_data | selectattr('threshold_exceeded') | list | length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-check-circle text-green-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Systems OK</dt>
                            <dd class="text-lg font-medium text-gray-900">
                                {{ live_data | rejectattr('threshold_exceeded') | list | length }}
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Total Systems</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ live_data | length }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white overflow-hidden shadow rounded-lg">
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <i class="fas fa-bell text-orange-500 text-2xl"></i>
                    </div>
                    <div class="ml-5 w-0 flex-1">
                        <dl>
                            <dt class="text-sm font-medium text-gray-500 truncate">Recent Alarms (24h)</dt>
                            <dd class="text-lg font-medium text-gray-900">{{ recent_alarms | length }}</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshEnabled = true;
let autoRefreshInterval;

function refreshData() {
    console.log('Refreshing data...');
    fetch('/api/live-data')
        .then(response => response.json())
        .then(data => {
            updateTable(data);
            document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
}

function updateTable(data) {
    // Update table rows with new data
    data.forEach(item => {
        const row = document.querySelector(`tr[data-threshold-ref="${item.threshold_ref}"]`);
        if (row) {
            // Update values
            const currentValue = row.querySelector('.current-value');
            if (currentValue) {
                currentValue.textContent = item.current_value ? item.current_value.toFixed(1) : 'N/A';
            }
            
            const shiftTotal = row.querySelector('.shift-total');
            if (shiftTotal) {
                shiftTotal.textContent = item.shift_total ? item.shift_total.toFixed(1) : '0';
            }
            
            const dayTotal = row.querySelector('.day-total');
            if (dayTotal) {
                dayTotal.textContent = item.day_total ? item.day_total.toFixed(1) : '0';
            }
            
            // Update status badge
            const statusBadge = row.querySelector('.status-badge');
            if (statusBadge) {
                if (item.threshold_exceeded) {
                    statusBadge.className = 'status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                    statusBadge.innerHTML = '<i class="fas fa-exclamation-triangle mr-1"></i>EXCEEDED';
                } else {
                    statusBadge.className = 'status-badge inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                    statusBadge.innerHTML = '<i class="fas fa-check mr-1"></i>OK';
                }
            }
            
            // Update row background color
            if (item.threshold_exceeded) {
                row.className = row.className.replace(/bg-\w+-\d+/, 'bg-red-50');
            } else {
                row.className = row.className.replace(/bg-red-50/, 'bg-white');
            }
        }
    });
}

function toggleAutoRefresh() {
    const btn = document.getElementById('auto-refresh-btn');
    autoRefreshEnabled = !autoRefreshEnabled;
    
    if (autoRefreshEnabled) {
        btn.innerHTML = '<i class="fas fa-clock mr-1"></i>Auto: ON';
        startAutoRefresh();
    } else {
        btn.innerHTML = '<i class="fas fa-clock mr-1"></i>Auto: OFF';
        clearInterval(autoRefreshInterval);
    }
}

function startAutoRefresh() {
    if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
    }
    
    // Refresh every 30 seconds
    autoRefreshInterval = setInterval(refreshData, 30000);
}

// Start auto-refresh when page loads
document.addEventListener('DOMContentLoaded', function() {
    startAutoRefresh();
    
    // Initial data refresh after 2 seconds
    setTimeout(refreshData, 2000);
});
</script>
{% endblock %}